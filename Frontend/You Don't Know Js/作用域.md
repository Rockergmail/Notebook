作用域

### 自己之前的理解
1. 作用域，就是变量有效的范围
1. 作用域可以嵌套，形成作用域链。当变量在里层的作用域找不到，会往上一级的作用找，直到最外层的作用域（global/window）无论找到或者找不到都会停止继续查找

### 作用域存在的意义

当程序需要获取变量的值，或者为变量赋值，程序如何找到这个变量？作用域就是程序找到这个变量的规则。

它负责收集并维护由所有声明的变量组成的一系列查询，并实施一套非常严格的规则，确定当前执行的代码对这些变量的访问权限。


### js引擎的工作流程

JavaScript归类为“动态”或“解释执行”语言，事实上它是一门编译语言，编译完马上执行（查资料）

**js引擎的工作流程：**

编译 [词法分析（Tokenizing）-> 语法分析（Parsing） -> 代码生成] -> 执行

**词法分析：**

把代码分解成词法单元（token）
```var a = 2;``` 分解为 ```var```、```a```、```=```、```2```、```;```

**语法分析：**

把词法单元数组转换成“抽象语法树”（Abstract Syntax Tree，AST）

**代码生成：**

将AST转化成一组机器指令，创建变量（包括分配内存），存值等操作

### 作用域的工作流程

当

```javascript
function foo (a) {

	console.log(a)
}

foo(2)
```

1. 编译阶段，遇到var a，检查本作用域是否已经一个变量叫做a，有则忽略该声明，继续编译；没有则在本作用域声明一个变量a，初始化它的值为undefined;
1. 执行阶段，

---

```javascript
function foo (a) {

	console.log(a + b)
}

var b = 2;

foo(2)
```

```javascript
function foo (a) {

	console.log(a + b)
}

b = a;

foo(2)
```

说明过程

### 反思 & 总结

之前理解作用域实在太粗浅表面了，其实要了解它的工作流程，还需要了解js引擎的工作原理。

作用域是一套规则，用于确定在何处以及如何查找变量（标识符）。如果查找的目的是对变量进行赋值，那么就会使用LHS查询；如果目的是获取变量的值，就会使用RHS查询。

LHS和RHS查询都会在当前执行作用域中开始，如果有需要（也就是说它们没有找到所需的标识符），就会向上级作用域继续查找目标标识符，这样每次上升一级作用域（一层楼），最后抵达全局作用域（顶层），无论找到或没找到都将停止。

不成功的RHS引用会导致抛出ReferenceError异常；
不成功的LHS引用会导致自动隐式地创建一个全局变量（非严格模式下）;
不成功的LHS引用会导致抛出ReferenceError异常（严格模式下）。

ReferenceError 同作用域判别失败相关，而TypeError 则代表作用域判别成功了，但是对结果的操作是非法或不合理的。

### 参考资料
《You Don't Know Js》（主要参考）