<!--
 * @description: 
 * @author: xiangrong.liu
 * @Date: 2021-06-01 15:12:40
 * @LastEditors: xiangrong.liu
 * @LastEditTime: 2021-06-01 18:36:05
-->

浏览器的组成

渲染进程，是由什么组成的，是如何工作的

从收到 HTML、CSS 和 JavaScript 字节到对其进行必需的处理，从而将它们转变成渲染的像素这一过程中有一些中间步骤，优化性能其实就是了解这些步骤中发生了什么 - 即关键渲染路径。

浏览器加载html之后，进行解析：字节--文本--tokens--nodes--DOM，当构建完DOM之后会执行domcontentloaded事件
扫描css、js等资源
下载css资源，阻塞渲染，下载完之后进行解析：字节--文本--token--node--CSSOM，构建完CSSOM，js脚本才可以执行
下载js资源，阻塞html解析，阻塞渲染，下载完马上执行，js执行原理--这里先忽略
DOM和CSSOM结合成渲染树，先进行布局（layout）：计算元素的大小和位置等信息；合并再进行绘制（paint、栅格化）
如果js改变了DOM或者CSSOM，会重新执行构建DOM、构建CSSOM、构建渲染树，进行回流、重排
浏览器有默认的样式，所以有现成的CSSOM，所以就算没有认为的引入CSS，也会进行渲染


根据渲染的工作原理，我们要遵循什么原则，优化渲染

浏览器到底是如何使用我们的 HTML、CSS 和 JavaScript 在屏幕上渲染像素的呢



下面简要概述了浏览器完成的步骤:

处理 HTML 标记并构建 DOM 树。
处理 CSS 标记并构建 CSSOM 树。
将 DOM 与 CSSOM 合并成一个渲染树。
根据渲染树来布局，以计算每个节点的几何信息。
将各个节点绘制到屏幕上。
如果 DOM 或 CSSOM 被修改，您只能再执行一遍以上所有步骤，以确定哪些像素需要在屏幕上进行重新渲染。

优化关键渲染路径就是指最大限度缩短执行上述第 1 步至第 5 步耗费的总时间。

html资源：
1. HTML 被视为阻塞渲染的资源，因为渲染需要DOM
2. 尽量别让脚本阻止

css资源：
1. 默认情况下，CSS 被视为阻塞渲染的资源，这意味着浏览器将不会渲染任何已处理的内容，直至 CSSOM 构建完毕。请务必精简您的 CSS，尽快提供它，并利用媒体类型和查询来解除对渲染的阻塞。

HTML 和 CSS 都是阻塞渲染的资源。

默认情况下，CSS 被视为阻塞渲染的资源。
我们可以通过媒体类型和媒体查询将一些 CSS 资源标记为不阻塞渲染。
浏览器会下载所有 CSS 资源，无论阻塞还是不阻塞。

JavaScript 也会阻止 DOM 构建和延缓网页渲染。 为了实现最佳性能，可以让您的 JavaScript 异步执行，并去除关键渲染路径中任何不必要的 JavaScript。

JavaScript 可以查询和修改 DOM 与 CSSOM。
JavaScript 执行会阻止 CSSOM。
除非将 JavaScript 显式声明为异步，否则它会阻止构建 DOM。

当 HTML 解析器遇到一个 script 标记时，它会暂停构建 DOM，将控制权移交给 JavaScript 引擎；等 JavaScript 引擎运行完毕，浏览器会从中断的地方恢复 DOM 构建。执行我们的内联脚本会阻止 DOM 构建，也就延缓了首次渲染。

如果浏览器尚未完成 CSSOM 的下载和构建，而我们却想在此时运行脚本，会怎样？答案很简单，对性能不利: 浏览器将延迟脚本执行和 DOM 构建，直至其完成 CSSOM 的下载和构建。

脚本在文档中的位置很重要。
当浏览器遇到一个 script 标记时，DOM 构建将暂停，直至脚本完成执行。
JavaScript 可以查询和修改 DOM 与 CSSOM。
JavaScript 执行将暂停，直至 CSSOM 就绪。

“优化关键渲染路径”在很大程度上是指了解和优化 HTML、CSS 和 JavaScript 之间的依赖关系谱。

如果是外部 JavaScript 文件，浏览器必须停下来，等待从磁盘、缓存或远程服务器获取脚本，这就可能给关键渲染路径增加数十至数千毫秒的延迟。

向 script 标记添加异步关键字可以指示浏览器在等待脚本可用期间不阻止 DOM 构建，这样可以显著提升性能。


作为每个可靠性能策略的基础，准确的评估和检测必不可少。 无法评估就谈不上优化。本文说明了评估 CRP 性能的不同方法

优化关键渲染路径能够让浏览器尽可能快地绘制网页: 更快的网页渲染速度可以提高吸引力、增加网页浏览量以及提高转化率。为了最大程度减少访客看到空白屏幕的时间，我们需要优化加载的资源及其加载顺序。


到目前为止，我们只关注了资源（CSS、JS 或 HTML 文件）可供处理后浏览器中会发生的情况，而忽略了从缓存或从网络获取资源所需的时间。

还需要考虑图片资源、字体资源


与纯 HTML 示例不同，我们还需要获取并解析 CSS 文件才能构建 CSSOM，要想构建渲染树，DOM 和 CSSOM 缺一不可。
由于网页上还有一个阻止 JavaScript 文件的解析器，系统会在下载并解析 CSS 文件之前阻止 domContentLoaded 事件: 因为 JavaScript 可能会查询 CSSOM，我们必须在下载 CSS 文件之前将其阻止，然后才能执行 JavaScript

如果我们用内联脚本替换外部脚本会怎样？即使直接将脚本内联到网页中，浏览器仍然无法在构建 CSSOM 之前执行脚本。简言之，内联 JavaScript 也会阻止解析器。

这与 JavaScript 是内联的还是外部的并无关系，因为只要浏览器遇到 script 标记，就会进行阻止，并等到 CSSOM 构建完毕。

with asyn，domcontentloaded会先执行。因为是等dom解析完再执行的js

优化关键渲染路径也并非轻而易举: 我们需要了解不同资源之间的依赖关系图，我们需要确定哪些资源是“关键资源”，我们还必须在不同策略中做出选择，找到在网页上加入这些资源的恰当方式。

让我们定义一下用来描述关键渲染路径的词汇:

**关键资源: ** 可能阻止网页首次渲染的资源。
**关键路径长度: ** 获取所有关键资源所需的往返次数或总时间。
**关键字节: ** 实现网页首次渲染所需的总字节数，它是所有关键资源传送文件大小的总和。我们包含单个 HTML 页面的第一个示例包含一项关键资源（HTML 文档）；关键路径长度也与 1 次网络往返相等（假设文件较小），而总关键字节数正好是 HTML 文档本身的传送大小。

为尽快完成首次渲染，我们需要最大限度减小以下三种可变因素:

关键资源的数量。
关键路径长度。
关键字节的数量。

**优化关键渲染路径的常规步骤如下: **

对关键路径进行分析和特性描述: 资源数、字节数、长度。
最大限度减少关键资源的数量: 删除它们，延迟它们的下载，将它们标记为异步等。
优化关键字节数以缩短下载时间（往返次数）。
优化其余关键资源的加载顺序: 您需要尽早下载所有关键资产，以缩短关键路径长度。

https://developers.google.com/web/fundamentals/performance/critical-rendering-path?hl=zh-cn